# 使用 nexus 搭建一个 maven 私有仓库（windows）

**以 nexus-3.31.1 为例。**

## 解压

解压之后，会有 nexus 和 sonatype-work 这两个文件夹。

## 启动

端口和主机信息在配置文件 ```./nexus/etc/nexus-default.properties```，端口默认 8081；可以把端口修改为 ```application-port=8080```。

以管理员身份运行cmd，安装服务 ```./nexus/bin/nexus.exe /install```，卸载服务 ```./nexus/bin/nexus.exe /uninstall```，在系统服务里启动 nexus 服务。

## 登录管理后台

后台有两个默认账号：admin 和 anonymous。

访问 ```http://192.168.0.10:8080/```，点击右上角的 ```Sign in```。首次登录会自动生成 ```./sonatype-work/nexus3/admin.password``` 文件，里面保存的是 admin 的初始密码。输入初始密码之后，可以根据后续提示修改密码。

***admin.password 文件是一次性的，登录成功并且修改了初始密码之后，该文件会被删除。***

## 管理 Repository

点击上方的配置按钮 ```Server administration and configuration```，默认打开 ```Repository administration```，点击 ```Repositories``` 打开仓库管理界面。

仓库的类型：

- ```proxy```: 代理仓库，主要是代理公共的远程仓库，比如 aliyun 
- ```group```: 仓库组，主要是将仓库汇总，将私有仓库和远程仓库汇总起来，然后对外提供一个地址。将 proxy 和 hosted 统一
- ```hosted```: 私有仓库，主要是将本地 jar 作为共享资源

默认的仓库：

- ```maven-central```: maven 中央库，默认从 ```https://repo1.maven.org/maven2/``` 拉 取jar
- ```maven-releases```: 私有仓库，存放稳定的发布版本，即版本号不会频繁变动
- ```maven-snapshots```: 私有仓库，存放快照版本，也就是存放未发布的不稳定版本，即版本号会频繁变动
- ```maven-public```: 仓库分组，把上面三个仓库组合在一起对外提供服务，在本地 maven 的配置文件 settings.xml 中使用
- ```nuget-hosted```: 本地存储，像官方仓库一样提供本地私有仓库的功能
   - hosted 有三种方式：Releases、Snapshot、Mixed
      - ```Releases```: 稳定的发布版本
      - ```Snapshot```: 未发布的不稳定版本
      - ```Mixed```: 混合版
- ```nuget.org-proxy```: 提供代理其它仓库的类型
- ```nuget-group```: 组类型，能够组合多个仓库为一个地址提供服务

Deployment 设置选项有三个值：

- ```Allow redeploy```: 允许同一个版本号下重复提交代码，nexus 以时间区分
- ```Disable redeploy```: 不允许同一个版本号下重复提交代码
- ```Read-Only```: 不允许提交任何版本

## 删除组件（jar）

1. 点击上方的配置按钮 ```Browse server contents```，点击左侧栏的 ```Browse```，比如点击列表里的 ```maven-releases``` 打开组件管理界面。
2. 选择要删除的组件，也就是 jar 文件夹，点击右侧的 ```Delete folder```。

## 配置 Maven

修改 ```./conf/settings.xml```：

```xml
<servers>
  <server>
    <id>maven-releases</id>
    <username>admin</username>
    <password>admin@123</password>
  </server>

  <server>
    <id>maven-snapshots</id>
    <username>admin</username>
    <password>admin@123</password>
  </server>
</servers>
```

## 配置 pom.xml

```xml
<distributionManagement>
    <!-- repository 的 id 必须和 maven 的 setting.xml 的 server 的 id 保持一致, 才能获取到 nexus 的账号密码 -->

    <repository>
        <id>maven-releases</id>
        <url>http://192.168.0.10:8080/repository/maven-releases/</url>
        <releases>
           <enabled>true</enabled>
        </releases>
        <snapshots>
           <enabled>false</enabled>
        </snapshots>
    </repository>

    <snapshotRepository>
        <id>maven-snapshots</id>
        <url>http://192.168.0.10:8080/repository/maven-snapshots/</url>
        <releases>
           <enabled>false</enabled>
        </releases>
        <snapshots>
           <enabled>true</enabled>
        </snapshots>
    </snapshotRepository>
</distributionManagement>
```

**注意：**

- **release 的版本号里不能出现 snapshot 的字样，否则会造成发布失败**
- **一般配置 ```maven-releases``` 即可**
- **为了防止私有仓库的服务器地址发生变动，可以通过域名和地址映射**
   1. 在本地的 ```C:\Windows\System32\drivers\etc\hosts``` 文件里添加 ```192.168.0.10  nexus``` 映射
   2. 配置 pom.xml
      ```xml
      <distributionManagement>
          <repository>
              <id>maven-releases</id>
              <url>http://nexus:8080/repository/maven-releases/</url>
              <releases>
                 <enabled>true</enabled>
              </releases>
              <snapshots>
                 <enabled>false</enabled>
              </snapshots>
          </repository>
      </distributionManagement>
      ```

## 发布本地 jar

使用 maven 插件 deploy 发布到私有仓库。
